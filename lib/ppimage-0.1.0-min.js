/**
 *前端模图片处理 ppimage：
 * 兼容性：IE9+
 * version: 0.1.0
 *@author：ppfyang(hzyang_fan@corp.netease.com)
 */

"use strict";(function(_global){var MODE={1:{method:1,options:{divisor:1,offset:0,_matrix:[0,-1,0,-1,5,-1,0,-1,0,1,0]}},2:{method:1,options:{divisor:1,offset:0,_matrix:[-6,-3,0,-3,1,3,0,3,6,1,0]}},3:{method:1,options:{divisor:1,offset:0,_matrix:[0,0,0,0,2,0,0,0,0,1,-255]}},4:{method:1,options:{divisor:1,offset:0,_matrix:[0,-2,0,-2,20,-2,0,-2,0,10,-40]}},5:{method:1,options:{divisor:1,offset:0,_matrix:[0,-1,0,-1,4,-1,0,-1,0,1,127]}},6:{method:1,options:{divisor:1,offset:0,_matrix:[0,1,0,1,1,1,0,1,0,5,0]}},7:{method:2,options:{}},8:{method:3,options:{divisor:1,offset:0,_param:"v = _options.offset / _options.divisor;",_r:" r += (100 + v);",_g:" g += (100 + v);",_b:" b += (100 + v);"}},9:{method:3,options:{divisor:1,offset:0,_param:"v = _options.offset / _options.divisor;",_r:" r -= (100 + v);",_g:" g -= (100 + v);",_b:" b -= (100 + v);"}},10:{method:3,options:{divisor:1,offset:0,_param:"v = ( r * (.3 + _options.offset) + g * (.59 + _options.offset) + b * (.11 + _options.offset)) / _options.divisor;",_r:" r = v;",_g:" g = v;",_b:" b = v;"}},11:{method:3,options:{divisor:1,offset:0,_param:"v = _options.offset / _options.divisor;",_r:" r = 255 - r + v;",_g:" g = 255 - g + v;",_b:" b = 255 - b + v;"}}};var RENDER={1:function(_input,_options,_opacity){var _output=document.createElement("canvas").getContext("2d").createImageData(_input);var w=_input.width,h=_input.height;var iD=_input.data,oD=_output.data;var m=_options._matrix;for(var y=1;y<h-1;y+=1){for(var x=1;x<w-1;x+=1){for(var c=0;c<3;c+=1){var i=(y*w+x)*4+c;oD[i]=_options.offset+(m[0]*iD[i-w*4-4]+m[1]*iD[i-w*4]+m[2]*iD[i-w*4+4]+m[3]*iD[i-4]+m[4]*iD[i]+m[5]*iD[i+4]+m[6]*iD[i+w*4-4]+m[7]*iD[i+w*4]+m[8]*iD[i+w*4+4])/_options.divisor}oD[(y*w+x)*4+3]=parseInt(_opacity/100*255)}}return _output},2:function(_input,_options,_opacity){var _output=document.createElement("canvas").getContext("2d").createImageData(_input);_output.data.set(_input.data);for(var x=0,column=_input.width;x<column;x++){for(var y=0,row=_input.height;y<row;y++){var idx=(x+y*column)*4;var midx=(((column-1)-x)+y*column)*4;_output.data[midx+0]=_input.data[idx+0];_output.data[midx+1]=_input.data[idx+1];_output.data[midx+2]=_input.data[idx+2];_output.data[midx+3]=parseInt(_opacity/100*255)}}return _output},3:function(_input,_options,_opacity){var _param=_options._param;var _fn='"use strict";'+"var pixels = _input.data;"+"for (var i = 0, n = pixels.length; i < n; i += 4) {"+(_param?"var "+_param.replace(/\sr\s/igm,"pixels[i]").replace(/\sg\s/igm,"pixels[i + 1]").replace(/\sb\s/igm,"pixels[i + 2]"):"")+_options._r.replace(/\sr\s/igm,"pixels[i]")+_options._g.replace(/\sg\s/igm,"pixels[i + 1]")+_options._b.replace(/\sb\s/igm,"pixels[i + 2]")+"pixels[i + 3] = parseInt("+_opacity+" / 100 * 255);"+"}"+"return _input;";var _render=new Function("_input, _options, _opacity",_fn);return _render.apply(this,[_input,_options,_opacity])}};var ppimage=function(_options,_callback){if({}.toString.call(_callback)=="[object Function]"){var _url=_options.url||"";var _image=new Image();_image.src=_url;_image.onerror=function(){throw new Error("Fail to load image!");return false};_image.onload=function(){var _w=_image.width,_h=_image.height;var _map={url:_url,sx:0,sy:0,nw:_w,nh:_h,w:_w,h:_h,opacity:100,quality:100,mode:0};for(var _option in _options){if(_options.hasOwnProperty(_option)&&_map.hasOwnProperty(_option)){_map[_option]=_options[_option]}}var _tempCanvas=document.createElement("canvas");_tempCanvas.width=_map.w;_tempCanvas.height=_map.h;if(!!_tempCanvas.getContext){var _tempCtx=_tempCanvas.getContext("2d");var _fileType="image/"+(_map.url.match(/^.*?\.(x-icon|png|bmp|svg)$/igm)?_map.url.match(/\.(\w+)$/)[1]:"jpeg");_tempCtx.drawImage(_image,_map.sx,_map.sy,_map.w,_map.h,0,0,_map.nw,_map.nh);if(!!_map.mode){try{var _tmp={};var _mode=MODE[_map.mode],_param=_mode.options;for(var _option in _param){if(_param.hasOwnProperty(_option)){_tmp[_option]=_param[_option]}}if(_options._options&&_options._options.offset){_tmp.offset=_options._options.offset}if(_options._options&&_options._options.divisor){_tmp.divisor=_options._options.divisor}var _imageData=_tempCtx.getImageData(0,0,_map.w,_map.h);var _newImage=RENDER[_mode.method](_imageData,_tmp,_map.opacity);_tempCtx.clearRect(0,0,_map.w,_map.h);_tempCtx.putImageData(_newImage,0,0)}catch(_err){console.log(_err)}}else{_tempCtx.globalAlpha=_map.opacity/100;_tempCtx.clearRect(0,0,_map.w,_map.h);_tempCtx.drawImage(_image,_map.sx,_map.sy,_map.w,_map.h,0,0,_map.nw,_map.nh)}_callback(_tempCanvas.toDataURL(_fileType.toLowerCase(),_map.quality/100))}else{_callback(_map.url)}}}else{throw new Error("Callback function not found!");return false}};_global.ppimage=ppimage})(window);